<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONTROLE DE ESTOQUE - SCM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fade-in 0.3s; }
        .sidebar-btn.active { background-color: #2563eb; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast { animation: slideIn 0.3s ease-out forwards; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
	
	/* Adicione isso dentro da tag <style> */
	.bg-capa {
    		background-image: linear-gradient(rgba(248, 250, 252, 0.8), rgba(248, 250, 252, 0.8)), url('capa.jpg');
    		background-size: cover;
    		background-position: center;
    		background-attachment: fixed;
	}
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col md:flex-row text-slate-800">

    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <aside class="w-full md:w-64 bg-slate-900 text-slate-400 flex flex-col shadow-2xl z-20">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <i data-lucide="package-search" class="text-blue-500"></i>
            <h1 class="text-white font-black text-xl tracking-tighter">ESTOQUE SCM</h1>
        </div>
        <nav class="p-4 flex-1 space-y-1">
            <button onclick="showTab('dashboard')" id="btn-dashboard" class="sidebar-btn active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors hover:bg-slate-800 hover:text-white">
                <i data-lucide="layout-dashboard" size="18"></i> Dashboard
            </button>
            <button onclick="showTab('movements')" id="btn-movements" class="sidebar-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors hover:bg-slate-800 hover:text-white">
                <i data-lucide="arrow-right-left" size="18"></i> Movimentar
            </button>
            <button onclick="showTab('new')" id="btn-new" class="sidebar-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors hover:bg-slate-800 hover:text-white">
                <i data-lucide="plus-circle" size="18"></i> Novo Cadastro
            </button>
            <button onclick="showTab('history')" id="btn-history" class="sidebar-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors hover:bg-slate-800 hover:text-white">
                <i data-lucide="list-checks" size="18"></i> Histórico
            </button>
        </nav>
        <div id="user-info" class="p-4 text-[10px] text-slate-600 border-t border-slate-800 uppercase tracking-widest">
            Iniciando...
        </div>
    </aside>

    <main class="flex-1 p-4 md:p-8 overflow-y-auto relative h-screen bg-capa">
        <header class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-8 sticky top-0 bg-slate-50/90 backdrop-blur-sm z-10 py-2">
            <h2 id="page-title" class="text-2xl font-black text-slate-800 uppercase tracking-tight">Visão Geral</h2>
            <div class="flex flex-wrap items-center gap-3">
                <div class="relative group">
                    <i data-lucide="search" size="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                    <input type="text" id="search-input" placeholder="Buscar por nome, status ou classe..." oninput="handleFilter()" class="pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-full text-sm outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 w-full md:w-64 transition-all shadow-sm">
                </div>
                <div class="flex items-center gap-2 px-3 py-1 bg-white rounded-full border border-slate-200 shadow-sm">
                    <div id="connection-status-dot" class="status-dot bg-slate-300"></div>
                    <span id="connection-status-text" class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Conectando...</span>
                </div>
            </div>
        </header>

        <div id="dashboard" class="tab-content active space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-purple-500 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-widest">Total Geral</p>
                            <h3 id="stat-total" class="text-3xl font-black text-slate-800 mt-1">0</h3>
                        </div>
                        <div class="p-2 bg-purple-50 rounded-lg text-purple-600"><i data-lucide="layers" size="20"></i></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-emerald-500 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-widest">Pronto Uso</p>
                            <h3 id="stat-pronto" class="text-3xl font-black text-slate-800 mt-1">0</h3>
                        </div>
                        <div class="p-2 bg-emerald-50 rounded-lg text-emerald-600"><i data-lucide="package-check" size="20"></i></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-indigo-500 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-widest">Estoque Classe A</p>
                            <h3 id="stat-class-a" class="text-3xl font-black text-slate-800 mt-1">0</h3>
                        </div>
                        <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600"><i data-lucide="star" size="20"></i></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-blue-500 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-widest">Em Remanufatura</p>
                            <h3 id="stat-reman" class="text-3xl font-black text-slate-800 mt-1">0</h3>
                        </div>
                        <div class="p-2 bg-blue-50 rounded-lg text-blue-600"><i data-lucide="wrench" size="20"></i></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-amber-500 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-widest">Em Retorno</p>
                            <h3 id="stat-retorno" class="text-3xl font-black text-slate-800 mt-1">0</h3>
                        </div>
                        <div class="p-2 bg-amber-50 rounded-lg text-amber-600"><i data-lucide="package-x" size="20"></i></div>
                    </div>
                </div>
                <!-- NOVO: Card Terceiros -->
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-orange-500 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-widest">Em Terceiros</p>
                            <h3 id="stat-terceiros" class="text-3xl font-black text-slate-800 mt-1">0</h3>
                        </div>
                        <div class="p-2 bg-orange-50 rounded-lg text-orange-600"><i data-lucide="users" size="20"></i></div>
                    </div>
                </div>
                <!-- NOVO: Card Danificados -->
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-red-500 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-widest">Danificados</p>
                            <h3 id="stat-danificados" class="text-3xl font-black text-slate-800 mt-1">0</h3>
                        </div>
                        <div class="p-2 bg-red-50 rounded-lg text-red-600"><i data-lucide="alert-triangle" size="20"></i></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Img</th>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Class</th>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Material</th>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Tipo</th>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Status</th>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Total</th>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Pronto</th>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Reman</th>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Retorno</th>
                                <!-- NOVO: Colunas Terceiros e Danificados -->
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Terceiros</th>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Danificados</th>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Min/Max</th>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="movements" class="tab-content space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="arrow-right-left" size="18" class="text-blue-600"></i>
                    Controle de Movimentação
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                    <button onclick="setTransType('in')" id="type-in" class="type-btn flex items-center justify-center gap-2 px-6 py-3 rounded-lg border-2 border-slate-200 text-slate-500 font-semibold text-sm transition-all hover:border-emerald-300">
                        <i data-lucide="arrow-down-circle" size="18"></i> Entrada
                    </button>
                    <button onclick="setTransType('out')" id="type-out" class="type-btn flex items-center justify-center gap-2 px-6 py-3 rounded-lg border-2 border-slate-200 text-slate-500 font-semibold text-sm transition-all hover:border-red-300">
                        <i data-lucide="arrow-up-circle" size="18"></i> Saída
                    </button>
                    <button onclick="setTransType('transfer')" id="type-transfer" class="type-btn flex items-center justify-center gap-2 px-6 py-3 rounded-lg border-2 border-slate-200 text-slate-500 font-semibold text-sm transition-all hover:border-blue-300">
                        <i data-lucide="repeat" size="18"></i> Transferência
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Material</label>
                        <select id="trans-item" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Quantidade</label>
                        <input type="number" id="trans-qty" min="1" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                    </div>
                    <div id="dynamic-locations" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                        <div id="container-origin">
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Origem</label>
                            <select id="trans-from" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                                <option value="stockPronto">Pronto Uso</option>
                                <option value="stockReman">Remanufatura</option>
                                <option value="stockRetorno">Retorno</option>
                                <!-- NOVO: Opções Terceiros e Danificados -->
                                <option value="stockTerceiros">Terceiros</option>
                                <option value="stockDanificados">Danificados</option>
                            </select>
                        </div>
                        <div id="container-destination" class="hidden">
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Destino</label>
                            <select id="trans-to" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                                <option value="stockPronto">Pronto Uso</option>
                                <option value="stockReman">Remanufatura</option>
                                <option value="stockRetorno">Retorno</option>
                                <!-- NOVO: Opções Terceiros e Danificados -->
                                <option value="stockTerceiros">Terceiros</option>
                                <option value="stockDanificados">Danificados</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Observação (opcional)</label>
                        <textarea id="trans-reason" rows="2" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all resize-none"></textarea>
                    </div>
                    <button onclick="handleTransaction()" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold shadow-sm hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="check-circle" size="18"></i> Confirmar Operação
                    </button>
                </div>
            </div>
        </div>

        <div id="new" class="tab-content space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="plus-circle" size="18" class="text-emerald-600"></i>
                    Cadastrar Novo Material
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Nome do Material</label>
                        <input type="text" id="new-name" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Tipo</label>
                            <select id="new-type" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all">
                                <option value="Insumo">Insumo</option>
                                <option value="Ferramenta">Ferramenta</option>
                                <option value="EPI">EPI</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Classificação ABC</label>
                            <select id="new-classification" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all">
                                <option value="A">Classe A - Alta Prioridade</option>
                                <option value="B">Classe B - Média Prioridade</option>
                                <option value="C" selected>Classe C - Baixa Prioridade</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Estoque Mínimo</label>
                            <input type="number" id="new-min" min="0" value="0" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Estoque Máximo</label>
                            <input type="number" id="new-max" min="0" value="0" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Foto do Material (opcional)</label>
                        <div class="flex items-center gap-3">
                            <label class="cursor-pointer px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium text-sm transition-colors flex items-center gap-2">
                                <i data-lucide="upload" size="16"></i> Selecionar Arquivo
                                <input type="file" id="new-image-file" accept="image/*" onchange="previewNewImage(this)" class="hidden">
                            </label>
                        </div>
                        <div id="new-image-preview" class="mt-3"></div>
                    </div>
                    <button onclick="addNewItem()" class="w-full px-6 py-3 bg-emerald-600 text-white rounded-lg font-semibold shadow-sm hover:bg-emerald-700 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="save" size="18"></i> Cadastrar Material
                    </button>
                </div>
            </div>
        </div>

        <div id="history" class="tab-content space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="list-checks" size="18" class="text-purple-600"></i>
                    Histórico de Movimentações
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Data/Hora</th>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Material</th>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Ação</th>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Qtd</th>
                                <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Observação</th>
                            </tr>
                        </thead>
                        <tbody id="history-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="edit-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 space-y-4">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="edit" size="18" class="text-blue-600"></i>
                    Editar Material
                </h3>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" size="20"></i>
                </button>
            </div>
            <input type="hidden" id="edit-id">
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Nome</label>
                <input type="text" id="edit-name" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Tipo</label>
                    <select id="edit-type" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500">
                        <option value="Insumo">Insumo</option>
                        <option value="Ferramenta">Ferramenta</option>
                        <option value="EPI">EPI</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Classe</label>
                    <select id="edit-classification" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500">
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Mín</label>
                    <input type="number" id="edit-min" min="0" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Máx</label>
                    <input type="number" id="edit-max" min="0" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500">
                </div>
            </div>
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Imagem Atual</label>
                <div id="edit-current-img-container" class="w-full h-32 bg-slate-50 rounded-lg flex items-center justify-center border border-slate-200 overflow-hidden">
                    <i data-lucide="image" class="text-slate-300"></i>
                </div>
            </div>
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Nova Imagem (opcional)</label>
                <label class="cursor-pointer px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 justify-center">
                    <i data-lucide="upload" size="16"></i> Alterar Foto
                    <input type="file" id="edit-image-file" accept="image/*" onchange="previewEditImage(this)" class="hidden">
                </label>
                <div id="edit-image-preview" class="mt-3"></div>
            </div>
            <button onclick="saveEditItem()" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold shadow-sm hover:bg-blue-700 transition-colors">
                Salvar Alterações
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const appId = window.location.pathname.split('/')[2];
        const firebaseConfig = { apiKey: "AIzaSyDUANLAbd89g-_HivTcJGMND5Si9OF6F2I", authDomain: "anthropic-artifact-e228e.firebaseapp.com", projectId: "anthropic-artifact-e228e", storageBucket: "anthropic-artifact-e228e.firebasestorage.app", messagingSenderId: "48218892463", appId: "1:48218892463:web:f3bcd739bbcb1e1ab73ea7" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentInventory = [];
        let currentHistory = [];
        let currentTransactionType = null;

        onAuthStateChanged(auth, (user) => {
            if(user) {
                const displayName = user.displayName || user.email || "Usuário";
                const firstName = displayName.split(' ')[0];
                document.getElementById('user-info').innerHTML = `<i data-lucide="user-circle" size="14" class="inline"></i> ${firstName}`;
                lucide.createIcons();
            }
        });

        const updateConnectionStatus = (status) => {
            const dot = document.getElementById('connection-status-dot');
            const text = document.getElementById('connection-status-text');
            if(status === 'connected') { dot.className = 'status-dot bg-emerald-500'; text.textContent = 'Online'; }
            else if(status === 'error') { dot.className = 'status-dot bg-red-500'; text.textContent = 'Erro'; }
            else { dot.className = 'status-dot bg-slate-300'; text.textContent = 'Conectando...'; }
        };

        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'), (snap) => {
            currentInventory = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderTable();
            updateConnectionStatus('connected');
        }, () => updateConnectionStatus('error'));

        onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'history'), orderBy('timestamp', 'desc'), limit(50)), (snap) => {
            currentHistory = snap.docs.map(d => d.data());
            renderHistory();
        });

        window.renderTable = () => {
            // MODIFICADO: Adicionados totalTerceiros e totalDanificados
            let totalPronto = 0, totalReman = 0, totalRetorno = 0, totalTerceiros = 0, totalDanificados = 0, classA = 0;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filtered = currentInventory.filter(i => {
                const name = (i.name || "").toLowerCase();
                const type = (i.type || "").toLowerCase();
                const classification = (i.classification || "").toLowerCase();
                return name.includes(searchTerm) || type.includes(searchTerm) || classification.includes(searchTerm);
            });
            const html = filtered.map(i => {
                const total = (i.stockPronto || 0) + (i.stockReman || 0) + (i.stockRetorno || 0) + (i.stockTerceiros || 0) + (i.stockDanificados || 0);
                totalPronto += i.stockPronto || 0;
                totalReman += i.stockReman || 0;
                totalRetorno += i.stockRetorno || 0;
                // NOVO: Acumular totais
                totalTerceiros += i.stockTerceiros || 0;
                totalDanificados += i.stockDanificados || 0;
                if(i.classification === 'A') classA += total;
                const status = total <= (i.minStock || 0) ? 'bg-red-100 text-red-700 border-red-300' : (total >= (i.maxStock || 0) ? 'bg-emerald-100 text-emerald-700 border-emerald-300' : 'bg-amber-100 text-amber-700 border-amber-300');
                const statusText = total <= (i.minStock || 0) ? 'Crítico' : (total >= (i.maxStock || 0) ? 'OK' : 'Atenção');
                const classColor = { A: 'bg-indigo-100 text-indigo-700 border-indigo-300', B: 'bg-blue-100 text-blue-700 border-blue-300', C: 'bg-slate-100 text-slate-700 border-slate-300' }[i.classification] || 'bg-slate-100 text-slate-700 border-slate-300';
                return `<tr class="border-b border-slate-100 hover:bg-slate-50/50 transition-colors">
                    <td class="px-4 py-3">${i.imageUrl ? `<img src="${i.imageUrl}" class="w-12 h-12 rounded-lg object-cover shadow-sm border border-slate-200">` : `<div class="w-12 h-12 bg-slate-100 rounded-lg flex items-center justify-center"><i data-lucide="image" size="16" class="text-slate-300"></i></div>`}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 text-[10px] font-bold uppercase rounded-md border ${classColor}">${i.classification || 'C'}</span></td>
                    <td class="px-4 py-3 font-semibold text-slate-800 text-sm">${i.name}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${i.type || 'N/A'}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 text-[10px] font-bold uppercase rounded-md border ${status}">${statusText}</span></td>
                    <td class="px-4 py-3 text-sm font-bold text-slate-800">${total}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${i.stockPronto || 0}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${i.stockReman || 0}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${i.stockRetorno || 0}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${i.stockTerceiros || 0}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${i.stockDanificados || 0}</td>
                    <td class="px-4 py-3 text-xs text-slate-500">${i.minStock || 0} / ${i.maxStock || 0}</td>
                    <td class="px-4 py-3">
                        <div class="flex gap-1">
                            <button onclick="openEditModal('${i.id}', '${i.name}', ${i.minStock || 0}, ${i.maxStock || 0}, '${i.type || 'Insumo'}', '${i.classification || 'C'}')" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded transition-colors" title="Editar"><i data-lucide="edit-2" size="14"></i></button>
                            <button onclick="deleteMaterial('${i.id}', '${i.name}')" class="p-1.5 text-red-600 hover:bg-red-50 rounded transition-colors" title="Excluir"><i data-lucide="trash-2" size="14"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            document.getElementById('inventory-table').innerHTML = html || `<tr><td colspan="13" class="text-center py-8 text-slate-400 text-sm">Nenhum item encontrado</td></tr>`;
            const grandTotal = totalPronto + totalReman + totalRetorno + totalTerceiros + totalDanificados;
            document.getElementById('stat-total').innerText = grandTotal;
            document.getElementById('stat-pronto').innerText = totalPronto;
            document.getElementById('stat-reman').innerText = totalReman;
            document.getElementById('stat-retorno').innerText = totalRetorno;
            // NOVO: Atualizar cards
            document.getElementById('stat-terceiros').innerText = totalTerceiros;
            document.getElementById('stat-danificados').innerText = totalDanificados;
            document.getElementById('stat-class-a').innerText = classA;
            const select = document.getElementById('trans-item');
            select.innerHTML = '<option value="">Selecione...</option>' + currentInventory.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
            lucide.createIcons();
        };

        window.renderHistory = () => {
            const html = currentHistory.map(h => {
                const actionColors = { Entrada: 'bg-emerald-100 text-emerald-700 border-emerald-300', Saída: 'bg-red-100 text-red-700 border-red-300', Transferência: 'bg-blue-100 text-blue-700 border-blue-300' };
                const color = actionColors[h.action] || 'bg-slate-100 text-slate-700 border-slate-300';
                return `<tr class="border-b border-slate-100 hover:bg-slate-50/50 transition-colors">
                    <td class="px-4 py-3 text-xs text-slate-500">${h.date}</td>
                    <td class="px-4 py-3 text-sm font-semibold text-slate-800">${h.item}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 text-[10px] font-bold uppercase rounded-md border ${color}">${h.action}</span></td>
                    <td class="px-4 py-3 text-sm font-bold text-slate-800">${h.qty}</td>
                    <td class="px-4 py-3 text-xs text-slate-500">${h.detail || '-'}</td>
                </tr>`;
            }).join('');
            document.getElementById('history-table').innerHTML = html || `<tr><td colspan="5" class="text-center py-8 text-slate-400 text-sm">Nenhuma movimentação registrada</td></tr>`;
        };

        window.handleFilter = () => renderTable();

        window.showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast px-6 py-3 rounded-lg shadow-lg text-white text-sm font-semibold ${type === 'error' ? 'bg-red-500' : 'bg-emerald-500'} flex items-center gap-2`;
            toast.innerHTML = `<i data-lucide="${type === 'error' ? 'alert-circle' : 'check-circle'}" size="16"></i> ${msg}`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => toast.remove(), 3000);
        };

        window.compressImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxSize = 800;
                    let w = img.width, h = img.height;
                    if(w > h) { if(w > maxSize) { h *= maxSize / w; w = maxSize; } }
                    else { if(h > maxSize) { w *= maxSize / h; h = maxSize; } }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        window.previewNewImage = (input) => {
            const container = document.getElementById('new-image-preview');
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => container.innerHTML = `<img src="${e.target.result}" class="w-24 h-24 rounded-lg object-cover shadow-sm border border-slate-200 mb-2"><span class="text-[10px] text-emerald-600 font-bold uppercase">Foto Selecionada</span>`;
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.previewEditImage = (input) => {
            const container = document.getElementById('edit-image-preview');
            const isEdit = true;
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if(isEdit) container.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                    else container.innerHTML = `<img src="${e.target.result}" class="w-24 h-24 rounded-lg object-cover shadow-sm border border-slate-200 mb-2"><span class="text-[10px] text-emerald-600 font-bold uppercase">Foto Selecionada</span>`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.openEditModal = (id, name, min, max, type, classification) => {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-min').value = min;
            document.getElementById('edit-max').value = max;
            const item = currentInventory.find(i => i.id === id);
            const imgContainer = document.getElementById('edit-current-img-container');
            if(item && item.imageUrl) imgContainer.innerHTML = `<img src="${item.imageUrl}" class="w-full h-full object-cover">`;
            else { imgContainer.innerHTML = `<i data-lucide="image" class="text-slate-300"></i>`; lucide.createIcons(); }
            document.getElementById('edit-type').value = type || 'Insumo';
            document.getElementById('edit-classification').value = classification || 'C';
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');

        window.saveEditItem = async () => {
            const id = document.getElementById('edit-id').value;
            const fileInput = document.getElementById('edit-image-file');
            try {
                let data = { name: document.getElementById('edit-name').value, minStock: parseInt(document.getElementById('edit-min').value), maxStock: parseInt(document.getElementById('edit-max').value), type: document.getElementById('edit-type').value, classification: document.getElementById('edit-classification').value };
                if(fileInput.files.length > 0) data.imageUrl = await compressImage(fileInput.files[0]);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id), data);
                showToast("Item atualizado!"); closeEditModal();
            } catch(e) { showToast("Erro ao editar.", "error"); }
        };

        window.setTransType = (type) => {
            currentTransactionType = type;
            document.querySelectorAll('.type-btn').forEach(b => {
                b.classList.remove('bg-white', 'shadow-md', 'text-emerald-600', 'text-red-600', 'text-blue-600');
                b.classList.add('text-slate-500');
            });
            const colors = { in: 'text-emerald-600', out: 'text-red-600', transfer: 'text-blue-600' };
            document.getElementById(`type-${type}`).classList.add('bg-white', 'shadow-md', colors[type]);
            
            document.getElementById('dynamic-locations').classList.remove('hidden'); 
            document.getElementById('container-origin').classList.remove('hidden');
            
            document.getElementById('container-destination').classList.toggle('hidden', type !== 'transfer');

            const labelOrigin = document.querySelector('#container-origin label');
            if(labelOrigin) labelOrigin.innerText = type === 'in' ? 'Local de Entrada' : 'Origem';
        };

        window.handleTransaction = async () => {
            const id = document.getElementById('trans-item').value;
            const qty = parseInt(document.getElementById('trans-qty').value);
            const from = document.getElementById('trans-from').value;
            const to = document.getElementById('trans-to').value;

            if(!id || isNaN(qty) || qty <= 0) return showToast("Dados inválidos", "error");
            
            const item = currentInventory.find(i => i.id === id);
            const data = { ...item }; delete data.id;

            if(currentTransactionType === 'in') {
                data[from] = (data[from] || 0) + qty;
            } else {
                if((data[from] || 0) < qty) return showToast("Saldo insuficiente!", "error");
                data[from] -= qty;
                if(currentTransactionType === 'transfer') data[to] = (data[to] || 0) + qty;
            }

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id), data);
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'history'), {
                    item: item.name, 
                    action: currentTransactionType === 'in' ? 'Entrada' : (currentTransactionType === 'out' ? 'Saída' : 'Transferência'),
                    qty, detail: document.getElementById('trans-reason').value || '', 
                    date: new Date().toLocaleString('pt-BR'), timestamp: serverTimestamp()
                });
                showToast("Sucesso!"); showTab('dashboard');
                document.getElementById('trans-qty').value = "";
                document.getElementById('trans-reason').value = "";
            } catch(e) { showToast("Erro ao processar.", "error"); }
        };

        window.addNewItem = async () => {
            const name = document.getElementById('new-name').value;
            if(!name) return showToast("Nome obrigatório", "error");
            const fileInput = document.getElementById('new-image-file');
            try {
                let imageUrl = fileInput.files.length > 0 ? await compressImage(fileInput.files[0]) : "";
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'), {
                    name, 
                    minStock: parseInt(document.getElementById('new-min').value) || 0, 
                    maxStock: parseInt(document.getElementById('new-max').value) || 0,
                    type: document.getElementById('new-type').value, 
                    classification: document.getElementById('new-classification').value,
                    imageUrl, 
                    stockPronto: 0, 
                    stockReman: 0, 
                    stockRetorno: 0,
                    // NOVO: Inicializar campos
                    stockTerceiros: 0,
                    stockDanificados: 0,
                    timestamp: serverTimestamp()
                });
                showToast("Item cadastrado!"); showTab('dashboard');
            } catch(e) { showToast("Erro ao gravar", "error"); }
        };

        window.deleteMaterial = async (id, name) => {
            if(confirm(`Excluir "${name}"?`)) {
                try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id)); showToast("Excluído."); }
                catch(e) { showToast("Erro ao excluir.", "error"); }
            }
        };

        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById(`btn-${id}`).classList.add('active');
            lucide.createIcons();
        };

        lucide.createIcons();
    </script>
</body>
</html>
